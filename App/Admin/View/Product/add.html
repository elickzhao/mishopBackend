<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="Bookmark" href="/favicon.ico">
    <link rel="Shortcut Icon" href="/favicon.ico" />
    <!--[if lt IE 9]>
    <script type="text/javascript" src="__PUBLIC__/admin/lib/html5shiv.js"></script>
    <script type="text/javascript" src="__PUBLIC__/admin/lib/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/admin/static/h-ui/css/H-ui.min.css" />
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/admin/static/h-ui.admin/css/H-ui.admin.css" />
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/admin/lib/Hui-iconfont/1.0.8/iconfont.css" />
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/admin/static/h-ui.admin/skin/default/skin.css" id="skin" />
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/admin/static/h-ui.admin/css/style.css" />
    <link rel="stylesheet" href="__PUBLIC__/admin/lib/webuploader/0.1.5/webuploader.css">
    <link rel="stylesheet" href="__PUBLIC__/admin/css/common.css">
    <link rel="stylesheet" href="__PUBLIC__/admin/lib/layui/css/layui.css">
    <!--[if IE 6]>
    <script type="text/javascript" src="__PUBLIC__/admin/lib/DD_belatedPNG_0.0.8a-min.js" ></script>
    <script>DD_belatedPNG.fix('*');</script>
    <![endif]-->
    <script type="text/javascript" src="__PUBLIC__/admin/js/jquery.js"></script>
    <script type="text/javascript" src="__PUBLIC__/admin/js/action.js"></script>
    <script type="text/javascript" src="__PUBLIC__/plugins/xheditor/xheditor-1.2.1.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__/plugins/xheditor/xheditor_lang/zh-cn.js"></script>
    <script type="text/javascript" src="__PUBLIC__/admin/js/jCalendar.js"></script>
    <script src="https://unpkg.com/wangeditor@3.0.15/release/wangEditor.min.js"></script>

    <!-- 开关按钮的样式和js  -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.3.4/css/bootstrap2/bootstrap-switch.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.3.4/js/bootstrap-switch.min.js" integrity="sha256-AKUJYz2DyEoZYHh2/+zPHm1tTdYb4cmG8HC2ydmTzM4="
        crossorigin="anonymous"></script>

    <style>
        #content {
            width: 770px;
            height: 300px;
        }

        /* 隐藏layui开关按钮多余样式 */

        .switch>.layui-form-checkbox {
            display: none !important;
            visibility: hidden !important;
        }

        #commentForm .layui-form-label {
            text-align: left;
        }

        /* 已上传图片 删除信息显示效果 */

        .box {
            position: relative;
            cursor: pointer;
        }

        .box .bmbox {
            width: 125px;
            height: 30px;
            background: rgba( 0, 0, 0, 0.7);
            position: absolute;
            bottom: 0px;
            left: 0px;
            display: none;
            color: white;
            text-align: center;
        }

        .box:hover .bmbox {
            display: block;

        }

        .tooltip.in {
            filter: alpha(opacity=60);
            opacity: .6
        }
    </style>

    <title>添加产品</title>
</head>

<body>
    <!-- 导航 -->
    <include File='Page/nav' />
    <!-- /导航 -->
    <div class="page-container cl">
        <div class="panel panel-default mt-40">
            <div class="panel-header">{$bc[1]}</div>
            <div class="panel-body">
                <form id="commentForm" class="form form-horizontal layui-form" action="?id={$id}&page={$page}&type={$type}&name={$name}&shop_id={$shop_id}"
                    method="post" enctype="multipart/form-data">

                    <!-- 商品名称 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">商品名称：</label>
                        </div>
                        <div class="formControls col-xs-8 col-sm-4">
                            <input type="text" class="input-text" placeholder="商品名称" name="name" id="name" value="{$pro_allinfo.name}" minlength="2"
                                required>
                        </div>
                        <label class="layui-form-label">
                            <span class="c-red text-l">*</span>
                        </label>
                    </div>
                    <!-- /商品名称 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 商品分类  -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">选择分类：</label>
                        </div>
                        <div class="formControls col-xs-8 col-sm-4">
                            <div class="layui-inline">
                                <!-- 这个宽度在不同浏览器大小会受到影响 以后看看解决 -->
                                <div class="layui-input-inline" style="width: 16rem;">
                                    <select class="lay-search" name="cateid" id="cateid" lay-filter="cid_1" lay-search lay-verify="cateid">
                                        <option value>一级分类</option>
                                        <volist name="cate_list" id="v">
                                            <option value="{$v.id}" <if condition="$v.id eq $pro_allinfo['tid']">selected="selected"</if>>-- {$v.name}</option>
                                        </volist>
                                    </select>
                                </div>

                                <div class="layui-input-inline" style="width: 16rem;">
                                    <?php if($catetwo) { ?>
                                    <select class="inp_1" name="cid" id="cid" lay-filter="cid_2" lay-search lay-verify="cateid">
                                        <option value>二级分类</option>
                                        <volist name="catetwo" id="v">
                                            <option value="{$v.id}" <if condition="$v.id eq $pro_allinfo['cid']">selected="selected"</if>>-- {$v.name}</option>
                                        </volist>
                                    </select>

                                    <?php } else { ?>
                                    <select class="inp_1" name="cid" id="cid" lay-filter="cid_2" lay-search lay-verify="cateid">
                                        <option value>二级分类</option>
                                    </select>
                                    <?php } ?>
                                </div>
                            </div>

                            <span class="help-block ">
                                <i class="Hui-iconfont c-danger">&#xe6e0;</i>
                                <cite class="c-999">必选项.没有二级栏目,请先添加二级栏目,否则无法发布</cite>
                            </span>
                        </div>
                        <label class="layui-form-label">
                            <span class="c-red text-l">*</span>
                            <!-- 添加栏目 -->
                            <a style="text-decoration:none" href="{:U('Category/add')}">
                                <i class="Hui-iconfont f-24 c-primary ml-10" data-toggle="tooltip" data-placement="top" data-delay="1500" title="添加栏目">
                                    <strong>&#xe610;</strong>
                                </i>
                            </a>
                        </label>
                    </div>
                    <!-- /商品分类 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 商品品牌 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">选择品牌: </label>
                        </div>
                        <div class="formControls col-xs-8 col-sm-4">
                            <select name="brand_id" id="brand_id">
                                <!-- 遍历 -->
                                <option value="">选择品牌</option>
                                <volist name="brand_list" id="v">
                                    <option value="{$v.id}" <if condition="$v.id eq $pro_allinfo['brand_id']">selected="selected"</if>>-- {$v.name}</option>
                                </volist>
                                <!-- 遍历 -->
                            </select>
                        </div>
                    </div>
                    <!-- /商品品牌 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 单位 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">单 位: </label>
                        </div>
                        <div class="formControls col-xs-8 col-sm-4">
                            <input type="text" class="input-text" placeholder="单 位" name="company" id="company" value="{$pro_allinfo.company}">
                            <span class="help-block ">
                                <i class="Hui-iconfont c-danger">&#xe6e0;</i>
                                <cite class="c-999">&nbsp;&nbsp;举例:个/只/件&nbsp;&nbsp;请根据产品来自行添加相应单位</cite>
                            </span>
                        </div>
                    </div>
                    <!-- /单位 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 原价 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">原 价：</label>
                        </div>

                        <div class="formControls col-xs-8 col-sm-4">
                            <input type="text" class="input-text " placeholder="原 价" name="price" id="price" value="{$pro_allinfo.price}">
                        </div>
                        <!-- <label class="layui-form-label">
                            <span class="c-red text-l">*</span>
                        </label> -->
                    </div>
                    <!-- /原价 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 优惠价 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">优惠价：</label>
                        </div>
                        <div class="formControls col-xs-8 col-sm-4">
                            <input type="text" class="input-text number" placeholder="优惠价" name="price_yh" id="price_yh" value="{$pro_allinfo.price_yh}"
                                required>
                        </div>
                        <label class="layui-form-label">
                            <span class="c-red text-l">*</span>
                        </label>
                    </div>
                    <!-- /优惠价 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 销量 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">销量：</label>
                        </div>
                        <div class="formControls col-xs-8 col-sm-4">
                            <input type="text" class="input-text" placeholder="销量" name="shiyong" id="shiyong" value="{$pro_allinfo.shiyong}">
                        </div>
                    </div>
                    <!-- /销量 -->

                    <div class="hr-line-dashed"></div>

                    <!-- <div class="row cl">
                        <label class="text-l ml-50  col-xs-4 col-sm-2">
                            <span class="c-red">*</span>赠送积分：</label>
                        <div class="formControls col-xs-8 col-sm-4">
                            <input type="text" class="input-text" placeholder="赠送积分" name="price_jf" id="price_jf" value="{$pro_allinfo.price_jf}">
                        </div>
                    </div> -->

                    <!-- 产品编号 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">商品编号：</label>
                        </div>
                        <div class="formControls col-xs-8 col-sm-4">
                            <input type="text" class="input-text number" placeholder="产品编号" name="pro_number" id="pro_number" value="{$pro_allinfo.pro_number}"
                                required>
                        </div>
                        <label class="layui-form-label">
                            <span class="c-red text-l">*</span>
                        </label>
                    </div>
                    <!-- /产品编号 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 原产地 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">原产地：</label>
                        </div>

                        <div class="formControls col-xs-8 col-sm-4">
                            <input type="text" class="input-text" placeholder="原产地" name="intro" id="intro" value="{$pro_allinfo.intro}">
                        </div>
                    </div>
                    <!-- /原产地 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 库存 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">库存：</label>
                        </div>

                        <div class="formControls col-xs-8 col-sm-4">
                            <input type="text" class="input-text number" lay-verify="num" placeholder="库存" name="num" id="num" value="<?php echo $pro_allinfo['num']==0 ? 999999 : $pro_allinfo['num']; ?>"
                                required>
                        </div>
                        <label class="layui-form-label">
                            <span class="c-red text-l">*</span>
                        </label>
                    </div>
                    <!-- /库存 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 缩略图 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">缩略图：</label>
                        </div>

                        <div class="formControls col-xs-8 col-sm-4">
                            <?php if ($pro_allinfo['photo_x']) { ?>
                            <img id='old_photo_x' src="__DATA__/<?php echo $pro_allinfo['photo_x']; ?>" width="80" height="80" style="margin-bottom: 3px;"
                            />
                            <br />
                            <?php } ?>
                            <span class="btn-upload form-group">
                                <input class="input-text upload-url radius" type="text" name="photo_x" id="photo_x" readonly>
                                <a href="javascript:void();" class="btn btn-primary radius">
                                    <i class="layui-icon">&#xe64a;</i> 浏览文件</a>
                                <input type="file" name="photo_x" id="photo_x" class="input-file" lay-verify="upImg">
                            </span>
                            <span class="help-block ">
                                <i class="Hui-iconfont c-danger">&#xe6e0;</i>
                                <cite class="c-999">必填项! 图片大小230*230</cite>
                            </span>
                        </div>
                        <label class="layui-form-label">
                            <span class="c-red text-l">*</span>
                        </label>
                    </div>
                    <!-- /缩略图 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 大图 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">大 图：</label>
                        </div>

                        <div class="formControls col-xs-8 col-sm-4">
                            <?php if ($pro_allinfo['photo_d']) { ?>
                            <img id='old_photo_d' src="__DATA__/<?php echo $pro_allinfo['photo_d']; ?>" width="125" height="125" style="margin-bottom: 3px;"
                            />
                            <br />
                            <?php } ?>
                            <span class="btn-upload form-group">
                                <input class="input-text upload-url radius" type="text" name="photo_d" id="photo_d" readonly>
                                <a href="javascript:void();" class="btn btn-primary radius">
                                    <i class="layui-icon">&#xe64a;</i> 浏览文件</a>
                                <input type="file" name="photo_d" id="photo_d" class="input-file" lay-verify="upImg">
                            </span>
                            <span class="help-block ">
                                <i class="Hui-iconfont c-danger">&#xe6e0;</i>
                                <cite class="c-999">必填项! 图片大小600*600</cite>
                            </span>
                        </div>
                        <label class="layui-form-label">
                            <span class="c-red text-l">*</span>
                        </label>
                    </div>
                    <!-- 大图 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 轮播图 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">轮播图：</label>
                        </div>
                        <div class="formControls col-xs-8 col-sm-4">


                            <style>
                            </style>
                            <?php if (is_array($img_str)) { ?>
                            <div class="layui-inline">
                                <?php foreach ($img_str as $v) { ?>
                                <div class="layui-input-inline box">
                                    <img src="__DATA__/<?php echo $v; ?>" width="125" height="125">
                                    <div class="bmbox" title="删除" onclick="del_img('<?php echo $v; ?>',this);">删除</div>
                                </div>
                                <?php } ?>
                            </div>
                            <span class="help-block ">
                                <i class="Hui-iconfont c-primary">&#xe6e0;</i>
                                <cite class="c-999">已上传图片</cite>
                            </span>
                            <?php } ?>

                            <div class="uploader-list-container">
                                <div class="queueList">
                                    <div id="dndArea" class="placeholder">
                                        <div id="filePicker-2"></div>
                                        <p>或将图片拖到这里，单次最多可选5张</p>
                                    </div>
                                </div>
                                <div class="statusBar" style="display:none;">
                                    <div class="progress">
                                        <span class="text">0%</span>
                                        <span class="percentage"></span>
                                    </div>
                                    <div class="info"></div>
                                    <div class="btns">
                                        <div id="filePicker2"></div>
                                        <div class="uploadBtn">开始上传</div>
                                    </div>
                                </div>
                            </div>
                            <span class="help-block ">
                                <i class="Hui-iconfont c-danger">&#xe6e0;</i>
                                <cite class="c-999">图片大小600*600</cite>
                            </span>
                            <input type="hidden" name="photo_string" id="slider" value="">
                        </div>
                    </div>
                    <!-- 轮播图 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 产品介绍 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">产品介绍：</label>
                        </div>
                        <div class="formControls col-xs-8 col-sm-6">
                            <div id="editor">
                                <p>{$pro_allinfo.content}</p>
                            </div>
                            <textarea id="text1" name="content" style="width:100%; height:200px;display:none"></textarea>
                            <!-- <textarea lay-ignore name="content" id="content" required/>{$pro_allinfo.content}</textarea> -->
                        </div>
                        <!-- 现在一些产品只有属性没有详细页 所以暂时不是必填项 -->
                        <!-- <label class="layui-form-label">
                            <span class="c-red text-l">*</span>
                        </label> -->
                    </div>
                    <!-- /产品介绍 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 人气 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">人气：</label>
                        </div>

                        <div class="formControls col-xs-8 col-sm-4">
                            <input type="text" class="input-text" placeholder="人气" name="renqi" id="renqi" value="<?php echo (int)$pro_allinfo['renqi']; ?>">
                        </div>
                    </div>
                    <!-- /人气 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 新上市 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">新上市：</label>
                        </div>

                        <div class="formControls col-xs-8 col-sm-4">
                            <div class="switch switch-large" data-on-label="是" data-off-label="否">
                                <input name="is_show" type="checkbox" value="1" <?php echo $pro_allinfo[ 'is_show']==1 ? 'checked="checked"' : null?> />
                            </div>
                        </div>
                    </div>
                    <!-- /新上市 -->

                    <div class="hr-line-dashed"></div>

                    <!-- 热销产品 -->
                    <div class="row cl">
                        <div class="col-xs-4 col-sm-2 ml-30">
                            <label class="layui-form-label">热销产品: </label>
                        </div>
                        <div class="formControls col-xs-8 col-sm-4 ">
                            <div class="switch switch-large" data-on-label="是" data-off-label="否">
                                <input name="is_hot" type="checkbox" value="1" <?php echo $pro_allinfo[ 'is_hot']==1 ? 'checked="checked"' : null?> />
                            </div>
                        </div>
                    </div>
                    <!-- /热销产品 -->

                    <div class="hr-line-dashed"></div>

                    <!-- <div class="row cl">
                        <label class="text-l ml-50  col-xs-4 col-sm-2">
                            <span class="c-red">*</span>品牌图片，图片大小120*120</label>
                        <div class="formControls col-xs-8 col-sm-4">
                            <input type="file" name="file" id="file" value="">
                        </div>
                    </div> -->


                    <div class="row cl">
                        <div class="col-xs-8 col-sm-9 col-xs-offset-4 col-sm-offset-2">
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            <input class="btn btn-primary radius" type="submit" name="submit" lay-submit lay-filter="*" value="&nbsp;&nbsp;提交&nbsp;&nbsp;">
                            <input type="hidden" name="pro_id" id='pro_id' value="{$pro_allinfo.id}">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>



    <!-- 底部 -->
    <include File='Page/footer' />
    <!-- /底部 -->


    <script>
        /*----------  单个input验证 不会像layui 验证弹出提示 ----------*/
        $(function () {
            //开启验证
            $("#commentForm").validate();

            //自动生成商品编号
            var pn = $("#pro_number").val();
            if (pn == "" || pn == 0) {
                var v = pr();
                $("#pro_number").val(v);
            }
        })

        /*----------  生成商品编号 并用于建立商品详情内容图片上传的目录  ----------*/
        function pr() {
            return Math.round(new Date().getTime() / 10000);
        }

        /*=============================================
        =            富文本编辑及上传图片              =
        =============================================*/

        var E = window.wangEditor
        var editor = new E('#editor')
        // 配置服务器端地址
        var url = '{:U("Upload/contentImage?flag=")}' + '?flag=' + pr();
        editor.customConfig.uploadImgServer = url;
        // 将图片大小限制为 3M
        editor.customConfig.uploadImgMaxSize = 2 * 1024 * 1024;
        // 限制一次最多上传 15 张图片
        editor.customConfig.uploadImgMaxLength = 15;

        editor.customConfig.uploadImgHooks = {
            success: function (xhr, editor, result) {
                // 图片上传并返回结果，图片插入成功之后触发
                // xhr 是 XMLHttpRequst 对象，editor 是编辑器对象，result 是服务器端返回的结果
                // console.log(xhr);
                // console.log(editor);
                // console.log(result);
            },
            fail: function (xhr, editor, result) {
                layer.msg('图片载入错误', {
                    icon: 5
                });
                console.log(xhr);
                console.log(editor);
                console.log(result);
                // 图片上传并返回结果，但图片插入错误时触发
                // xhr 是 XMLHttpRequst 对象，editor 是编辑器对象，result 是服务器端返回的结果
            },
            error: function (xhr, editor) {
                // 图片上传出错时触发
                console.log(xhr);
                console.log(editor);
                // xhr 是 XMLHttpRequst 对象，editor 是编辑器对象
            },
            timeout: function (xhr, editor) {
                // 图片上传超时时触发
                layer.msg('上传超时!', {
                    icon: 5
                });
                console.log(xhr);
                console.log(editor);
                // xhr 是 XMLHttpRequst 对象，editor 是编辑器对象
            },
        }
        var $text1 = $('#text1');
        editor.customConfig.onchange = function (html) {
            // 监控变化，同步更新到 textarea
            $text1.val(html)
        }
        editor.create();
        // 初始化 textarea 的值
        $text1.val(editor.txt.html())
        /*=====  End of 富文本编辑及上传图片 ======*/




        /*=============================================
        =            分类二级联动                      =
        =============================================*/
        var form = layui.form;
        form.on('select(cid_1)', function (data) {
            var cateid = data.value;
            $.post('{:U("getcid")}', {
                cateid: cateid,
                async: false,
            }, function (data) {
                if (data.catelist != '') {
                    var htmls = '<option value="">二级分类</option>';
                    var cate = data.catelist;

                    $(cate).each(function (v, k) {
                        htmls += "<option value='" + k.id + "'>" + k.name +
                            "</option>";
                    });

                    $('#cid').html(htmls);
                    form.render('select'); //这里只有这么写才可以 看来某些东西冲突了
                } else {
                    $('#cid').html('<option value="">二级分类</option>');
                    form.render('select');
                }
            }, "json");
        });
        /*=====  End of 分类二级联动  ======*/


        /*=============================================
        =            表单自定义验证                    =
        =============================================*/
        //自定义验证规则  
        form.verify({
            cateid: function (value) {
                if (value == "") {
                    //滚动到指定元素位置 //可能是因为iframe的关系 只能指定高度了 而不能指定元素
                    //console.log($("#cid").offset().top);
                    $('html, body').scrollTop(100);
                    return "必须选择栏目";
                }
            },
            upImg: function (value) {
                var old_photo_x = $('#old_photo_x').length;
                var old_photo_d = $('#old_photo_d').length;
                if (value == "" && !old_photo_x && !old_photo_d) {
                    return "请先上传图片!";
                }
            },
            num: function (value) {
                if (parseInt(value) < 0 || isNaN(value)) {
                    return "请填写正确数字!";
                }
            }
        });

        //提交监听事件    //没这个是不行的 否则自定义验证不生效
        form.on('submit(*)', function (data) {
            //这先留着 查看提交数据用
            // console.log(data.field);
            // return false;
        });
        /*=====  End of 表单自定义验证  ======*/

        //图片删除
        function del_img(img, obj) {
            var pro_id = $('#pro_id').val();
            if (confirm('是否确认删除？')) {
                $.post('{:U("img_del")}', {
                    img_url: img,
                    pro_id: pro_id
                }, function (data) {
                    if (data.status == 1) {
                        $(obj).parent().remove();
                        return false;
                    } else {
                        alert(data.err);
                        return false;
                    }
                }, "json");
            };
        }



        (function ($) {
            // 当domReady的时候开始初始化
            $(function () {

                /*----------  定义一些变量  ----------*/
                var $wrap = $('.uploader-list-container'),

                    // 图片容器
                    $queue = $('<ul class="filelist"></ul>')
                    .appendTo($wrap.find('.queueList')),

                    // 状态栏，包括进度和控制按钮
                    $statusBar = $wrap.find('.statusBar'),

                    // 文件总体选择信息。
                    $info = $statusBar.find('.info'),

                    // 上传按钮
                    $upload = $wrap.find('.uploadBtn'),

                    // 没选择文件之前的内容。
                    $placeHolder = $wrap.find('.placeholder'),

                    $progress = $statusBar.find('.progress').hide(),

                    // 添加的文件数量
                    fileCount = 0,

                    // 添加的文件总大小
                    fileSize = 0,

                    // 优化retina, 在retina下这个值是2
                    ratio = window.devicePixelRatio || 1,

                    // 缩略图大小
                    thumbnailWidth = 110 * ratio,
                    thumbnailHeight = 110 * ratio,

                    // 可能有pedding, ready, uploading, confirm, done.
                    state = 'pedding',

                    // 所有文件的进度信息，key为file id
                    percentages = {},
                    // 判断浏览器是否支持图片的base64
                    isSupportBase64 = (function () {
                        var data = new Image();
                        var support = true;
                        data.onload = data.onerror = function () {
                            if (this.width != 1 || this.height != 1) {
                                support = false;
                            }
                        }
                        data.src =
                            "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
                        return support;
                    })(),


                    /*----------  检测是否已经安装flash，检测flash的版本  ----------*/
                    flashVersion = (function () {
                        var version;

                        try {
                            version = navigator.plugins['Shockwave Flash'];
                            version = version.description;
                        } catch (ex) {
                            try {
                                version = new ActiveXObject('ShockwaveFlash.ShockwaveFlash')
                                    .GetVariable('$version');
                            } catch (ex2) {
                                version = '0.0';
                            }
                        }
                        version = version.match(/\d+/g);
                        return parseFloat(version[0] + '.' + version[1], 10);
                    })(),

                    supportTransition = (function () {
                        var s = document.createElement('p').style,
                            r = 'transition' in s ||
                            'WebkitTransition' in s ||
                            'MozTransition' in s ||
                            'msTransition' in s ||
                            'OTransition' in s;
                        s = null;
                        return r;
                    })(),

                    // WebUploader实例
                    uploader;

                if (!WebUploader.Uploader.support('flash') && WebUploader.browser.ie) {

                    // flash 安装了但是版本过低。
                    if (flashVersion) {
                        (function (container) {
                            window['expressinstallcallback'] = function (state) {
                                switch (state) {
                                    case 'Download.Cancelled':
                                        layer.msg('您取消了更新！', {
                                            icon: 0
                                        });
                                        break;

                                    case 'Download.Failed':
                                        layer.msg('安装失败', {
                                            icon: 5
                                        });
                                        break;

                                    default:
                                        layer.msg('安装已成功，请刷新！', {
                                            icon: 1
                                        });

                                        break;
                                }
                                delete window['expressinstallcallback'];
                            };

                            var swf = 'expressInstall.swf';
                            // insert flash object
                            var html = '<object type="application/' +
                                'x-shockwave-flash" data="' + swf + '" ';

                            if (WebUploader.browser.ie) {
                                html += 'classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" ';
                            }

                            html += 'width="100%" height="100%" style="outline:0">' +
                                '<param name="movie" value="' + swf + '" />' +
                                '<param name="wmode" value="transparent" />' +
                                '<param name="allowscriptaccess" value="always" />' +
                                '</object>';

                            container.html(html);

                        })($wrap);

                        // 压根就没有安转。
                    } else {
                        $wrap.html(
                            '<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>'
                        );
                    }

                    return;
                } else if (!WebUploader.Uploader.support()) {
                    alert('Web Uploader 不支持您的浏览器！');
                    return;
                }

                var url = '{:U("Upload/UploadImage")}' + '?flag=product/' + pr();
                /*----------  实例化uploader  ----------*/
                uploader = WebUploader.create({
                    pick: {
                        id: '#filePicker-2',
                        label: '点击选择图片'
                    },
                    formData: {
                        uid: 123
                    },
                    dnd: '#dndArea',
                    paste: '#uploader',
                    swf: '__PUBLIC__/admin/lib/webuploader/0.1.5/Uploader.swf',
                    threads: 5,
                    chunked: false, //分片处理大文件
                    chunkSize: 512 * 1024, //分片大小5m
                    server: url, //服务器端地址
                    // runtimeOrder: 'flash',
                    //限制文件必须是图片
                    accept: {
                        title: 'Images',
                        extensions: 'gif,jpg,jpeg,bmp,png',
                        mimeTypes: 'image/*'
                    },
                    compress: { //图片压缩选项    如果有问题 就把这项去掉
                        width: 600,
                        height: 600,

                        // 图片质量，只有type为`image/jpeg`的时候才有效。
                        quality: 90,

                        // 是否允许放大，如果想要生成小图的时候不失真，此选项应该设置为false.
                        allowMagnify: false,

                        // 是否允许裁剪。
                        crop: false,

                        // 是否保留头部meta信息。
                        preserveHeaders: true,

                        // 如果发现压缩后文件大小比原来还大，则使用原来图片
                        // 此属性可能会影响图片自动纠正功能
                        noCompressIfLarger: false,

                        // 单位字节，如果图片大小小于此值，不会采用压缩。
                        compressSize: 0
                    },
                    // 禁掉全局的拖拽功能。这样不会出现图片拖进页面的时候，把图片打开。
                    disableGlobalDnd: true,
                    fileNumLimit: 10, //图片个数限制
                    fileSizeLimit: 5 * 1024 * 1024, // 5 M  文件总大小超出不允许加入队列
                    fileSingleSizeLimit: 2 * 1024 * 1024 // 2 M  单个文件总大小
                });

                // 拖拽时不接受 js, txt 文件。
                uploader.on('dndAccept', function (items) {
                    var denied = false,
                        len = items.length,
                        i = 0,
                        // 修改js类型
                        unAllowed = 'text/plain;application/javascript ';

                    for (; i < len; i++) {
                        // 如果在列表里面
                        if (~unAllowed.indexOf(items[i].type)) {
                            denied = true;
                            break;
                        }
                    }

                    return !denied;
                });

                uploader.on('dialogOpen', function () {
                    console.log('here');
                });


                // 添加“添加文件”的按钮，
                uploader.addButton({
                    id: '#filePicker2',
                    label: '继续添加'
                });

                uploader.on('ready', function () {
                    window.uploader = uploader;
                });

                // 当有文件添加进来时执行，负责view的创建
                function addFile(file) {
                    var $li = $('<li id="' + file.id + '">' +
                            '<p class="title">' + file.name + '</p>' +
                            '<p class="imgWrap"></p>' +
                            '<p class="progress"><span></span></p>' +
                            '</li>'),

                        $btns = $('<div class="file-panel">' +
                            '<span class="cancel">删除</span>' +
                            '<span class="rotateRight">向右旋转</span>' +
                            '<span class="rotateLeft">向左旋转</span></div>').appendTo($li),
                        $prgress = $li.find('p.progress span'),
                        $wrap = $li.find('p.imgWrap'),
                        $info = $('<p class="error"></p>'),

                        showError = function (code) {
                            switch (code) {
                                case 'exceed_size':
                                    text = '文件大小超出';
                                    break;

                                case 'interrupt':
                                    text = '上传暂停';
                                    break;

                                default:
                                    text = '上传失败，请重试';
                                    break;
                            }

                            $info.text(text).appendTo($li);
                        };

                    if (file.getStatus() === 'invalid') {
                        showError(file.statusText);
                    } else {
                        // @todo lazyload
                        $wrap.text('预览中');
                        uploader.makeThumb(file, function (error, src) {
                            var img;

                            if (error) {
                                $wrap.text('不能预览');
                                return;
                            }

                            if (isSupportBase64) {
                                img = $('<img src="' + src + '">');
                                $wrap.empty().append(img);
                            } else {
                                $.ajax('lib/webuploader/0.1.5/server/preview.php', {
                                    method: 'POST',
                                    data: src,
                                    dataType: 'json'
                                }).done(function (response) {
                                    if (response.result) {
                                        img = $('<img src="' + response.result +
                                            '">');
                                        $wrap.empty().append(img);
                                    } else {
                                        $wrap.text("预览出错");
                                    }
                                });
                            }
                        }, thumbnailWidth, thumbnailHeight);

                        percentages[file.id] = [file.size, 0];
                        file.rotation = 0;
                    }

                    file.on('statuschange', function (cur, prev) {
                        if (prev === 'progress') {
                            $prgress.hide().width(0);
                        } else if (prev === 'queued') {
                            $li.off('mouseenter mouseleave');
                            $btns.remove();
                        }

                        // 成功
                        if (cur === 'error' || cur === 'invalid') {
                            console.log(file.statusText);
                            showError(file.statusText);
                            percentages[file.id][1] = 1;
                        } else if (cur === 'interrupt') {
                            showError('interrupt');
                        } else if (cur === 'queued') {
                            percentages[file.id][1] = 0;
                        } else if (cur === 'progress') {
                            $info.remove();
                            $prgress.css('display', 'block');
                        } else if (cur === 'complete') {
                            $li.append('<span class="success"></span>');
                        }

                        $li.removeClass('state-' + prev).addClass('state-' + cur);
                    });

                    $li.on('mouseenter', function () {
                        $btns.stop().animate({
                            height: 30
                        });
                    });

                    $li.on('mouseleave', function () {
                        $btns.stop().animate({
                            height: 0
                        });
                    });

                    $btns.on('click', 'span', function () {
                        var index = $(this).index(),
                            deg;

                        switch (index) {
                            case 0:
                                uploader.removeFile(file);
                                return;

                            case 1:
                                file.rotation += 90;
                                break;

                            case 2:
                                file.rotation -= 90;
                                break;
                        }

                        if (supportTransition) {
                            deg = 'rotate(' + file.rotation + 'deg)';
                            $wrap.css({
                                '-webkit-transform': deg,
                                '-mos-transform': deg,
                                '-o-transform': deg,
                                'transform': deg
                            });
                        } else {
                            $wrap.css('filter',
                                'progid:DXImageTransform.Microsoft.BasicImage(rotation=' +
                                (~~(
                                    (file.rotation / 90) % 4 + 4) % 4) + ')');

                        }


                    });

                    $li.appendTo($queue);
                }

                // 负责view的销毁
                function removeFile(file) {
                    var $li = $('#' + file.id);

                    delete percentages[file.id];
                    updateTotalProgress();
                    $li.off().find('.file-panel').off().end().remove();
                }

                function updateTotalProgress() {
                    var loaded = 0,
                        total = 0,
                        spans = $progress.children(),
                        percent;

                    $.each(percentages, function (k, v) {
                        total += v[0];
                        loaded += v[0] * v[1];
                    });

                    percent = total ? loaded / total : 0;


                    spans.eq(0).text(Math.round(percent * 100) + '%');
                    spans.eq(1).css('width', Math.round(percent * 100) + '%');
                    updateStatus();
                }

                function updateStatus() {
                    var text = '',
                        stats;

                    if (state === 'ready') {
                        text = '选中' + fileCount + '张图片，共' +
                            WebUploader.formatSize(fileSize) + '。';
                    } else if (state === 'confirm') {
                        stats = uploader.getStats();
                        if (stats.uploadFailNum) {
                            text = '已成功上传' + stats.successNum + '张，' +
                                stats.uploadFailNum + '张照片上传失败.'
                        }

                    } else {
                        stats = uploader.getStats();
                        text = '共' + fileCount + '张（' +
                            WebUploader.formatSize(fileSize) +
                            '），已上传' + stats.successNum + '张';

                        if (stats.uploadFailNum) {
                            text += '，失败' + stats.uploadFailNum + '张';
                        }
                    }

                    $info.html(text);
                }

                function setState(val) {
                    var file, stats;

                    if (val === state) {
                        return;
                    }

                    $upload.removeClass('state-' + state);
                    $upload.addClass('state-' + val);
                    state = val;

                    switch (state) {
                        case 'pedding':
                            $placeHolder.removeClass('element-invisible');
                            $queue.hide();
                            $statusBar.addClass('element-invisible');
                            uploader.refresh();
                            break;

                        case 'ready':
                            $placeHolder.addClass('element-invisible');
                            $('#filePicker2').removeClass('element-invisible');
                            $queue.show();
                            $statusBar.removeClass('element-invisible');
                            uploader.refresh();
                            break;

                        case 'uploading':
                            $('#filePicker2').addClass('element-invisible');
                            $progress.show();
                            $upload.text('暂停上传');
                            break;

                        case 'paused':
                            $progress.show();
                            $upload.text('继续上传');
                            break;

                        case 'confirm':
                            $progress.hide();
                            $('#filePicker2').removeClass('element-invisible');
                            $upload.text('开始上传');

                            stats = uploader.getStats();
                            if (stats.successNum && !stats.uploadFailNum) {
                                setState('finish');
                                return;
                            }
                            break;
                        case 'finish':
                            stats = uploader.getStats();
                            if (stats.successNum) {
                                layer.msg('上传成功', {
                                    icon: 1
                                });
                            } else {
                                // 没有成功的图片，重设
                                state = 'done';
                                location.reload();
                            }
                            break;
                    }

                    updateStatus();
                }

                uploader.onUploadProgress = function (file, percentage) {
                    var $li = $('#' + file.id),
                        $percent = $li.find('.progress span');

                    $percent.css('width', percentage * 100 + '%');
                    percentages[file.id][1] = percentage;
                    updateTotalProgress();
                };

                uploader.onFileQueued = function (file) {
                    fileCount++;
                    fileSize += file.size;

                    if (fileCount === 1) {
                        $placeHolder.addClass('element-invisible');
                        $statusBar.show();
                    }

                    addFile(file);
                    setState('ready');
                    updateTotalProgress();
                };

                uploader.onFileDequeued = function (file) {
                    fileCount--;
                    fileSize -= file.size;

                    if (!fileCount) {
                        setState('pedding');
                    }

                    removeFile(file);
                    updateTotalProgress();

                };

                uploader.on('all', function (type) {
                    var stats;
                    switch (type) {
                        case 'uploadFinished':
                            setState('confirm');
                            break;

                        case 'startUpload':
                            setState('uploading');
                            break;

                        case 'stopUpload':
                            setState('paused');
                            break;

                    }
                });
                uploader.on('uploadSuccess', function (file, response) {
                    var slider = $('#slider').val();
                    var result = (slider == "") ? response.data : slider + "," + response.data;
                    $('#slider').val(result);
                    console.log(result + "---");
                });

                uploader.onError = function (code) {
                    layer.msg('Eroor: ' + code, {
                        icon: 2
                    });
                };

                $upload.on('click', function () {
                    if ($(this).hasClass('disabled')) {
                        return false;
                    }

                    if (state === 'ready') {
                        uploader.upload();
                    } else if (state === 'paused') {
                        uploader.upload();
                    } else if (state === 'uploading') {
                        uploader.stop();
                    }
                });

                $info.on('click', '.retry', function () {
                    uploader.retry();
                });

                $info.on('click', '.ignore', function () {
                    layer.msg('todo', {
                        icon: 5
                    });
                });

                $upload.addClass('state-' + state);
                updateTotalProgress();
            });

        })(jQuery);
    </script>

</body>

</html>